#!/bin/bash

# This script generates a CSV report from PokÃ©mon data files
# and calculates the average height and weight.

INPUT_DIR="pokemon_data"
REPORT_FILE="pokemon_report.csv"

# Check if the input directory exists
if [ ! -d "$INPUT_DIR" ]; then
    echo "Error: Directory '$INPUT_DIR' not found."
    echo "Please run the batch processing script first."
    exit 1
fi

# Write the header to the CSV file
echo "Name,Height (m),Weight (kg)" > "$REPORT_FILE"

# Loop through all JSON files in the directory
for file in "$INPUT_DIR"/*.json; do
  if [ -f "$file" ]; then
    # Extract data, convert units, format, and append to the report
    jq -r '[.name, .height, .weight] | @tsv' "$file" | \
    awk -F'\t' '{ 
        name = $1
        height_m = $2 / 10
        weight_kg = $3 / 10
        
        cap_name = toupper(substr(name, 1, 1)) substr(name, 2)
        
        printf "%s,%.1f,%.1f\n", cap_name, height_m, weight_kg
    }' >> "$REPORT_FILE"
  fi
done

# Check if the report was created and is not empty (besides the header)
if [ ! -s "$REPORT_FILE" ] || [ $(wc -l < "$REPORT_FILE") -le 1 ]; then
    echo "Error: Failed to generate report. No data found in '$INPUT_DIR'."
    exit 1
fi

echo "CSV Report generated at: $REPORT_FILE"
echo ""

# Print the content of the CSV file
cat "$REPORT_FILE"
echo ""

# Use awk to calculate and print the average height and weight
awk -F',' ' 
    # Skip the header row
    NR > 1 {
        height_sum += $2
        weight_sum += $3
        count++
    }
    END {
        if (count > 0) {
            printf "Average Height: %.2f m\n", height_sum / count
            printf "Average Weight: %.2f kg\n", weight_sum / count
        }
    }
' "$REPORT_FILE"
